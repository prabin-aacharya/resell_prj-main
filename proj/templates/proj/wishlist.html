{% extends 'proj/base.html' %}
{% load static %}
{% block title %}My Wishlist{% endblock title %}

{% block main-content %}
{% csrf_token %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card border-0 shadow-lg rounded-3 overflow-hidden">
        <div class="card-header bg-success text-white py-4">
          <div class="d-flex align-items-center">
            <div class="profile-icon me-3">
              <i class="fas fa-heart fa-3x"></i>
            </div>
            <div>
              <h3 class="mb-0">My Wishlist</h3>
              <p class="mb-0 small">Bikes you're interested in</p>
            </div>
          </div>
        </div>
        
        <div class="card-body p-0">
          <div class="row g-0">
            <!-- Sidebar Navigation -->
            <div class="col-md-3 border-end">
              <div class="nav flex-column nav-pills p-4" role="tablist">
                <a class="nav-link mb-3 d-flex align-items-center" href="{% url 'main:profile' %}">
                  <i class="fas fa-id-card me-2"></i> My Profile
                </a>
                <a class="nav-link mb-3 d-flex align-items-center" href="{% url 'main:address' %}">
                  <i class="fas fa-map-marker-alt me-2"></i> My Addresses
                </a>
                <a class="nav-link active mb-3 d-flex align-items-center" href="{% url 'main:wishlist' %}">
                  <i class="fas fa-heart me-2"></i> My Wishlist
                </a>
              </div>
            </div>
            
            <!-- Wishlist Content -->
            <div class="col-md-9">
              <div class="p-4 p-md-5">
                <h4 class="mb-4 border-bottom pb-3">
                  <i class="fas fa-heart me-2"></i>Saved Bikes ({{ products|length }})
                </h4>
                
                <div class="row g-4">
                  {% for product in products %}
                  <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm position-relative bike-card-hover">
                      <button class="btn wishlist-btn position-absolute end-0 top-0 m-2 bg-white rounded-circle p-2 shadow-sm" 
                              data-product-id="{{ product.id }}" 
                              title="Remove from Wishlist">
                        <i class="fas fa-heart text-danger"></i>
                      </button>
                      <img src="{{ product.product_image.url }}" class="card-img-top" style="height: 180px; object-fit: cover;" alt="{{ product.title }}">
                      <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <h6 class="card-title mb-0 fw-bold">{{ product.title }}</h6>
                          <span class="badge bg-success">{{ product.condition }}</span>
                        </div>
                        <p class="mb-1 small"><i class="fas fa-tag text-success me-1"></i> {{ product.brand }}</p>
                        <p class="mb-1 text-danger fw-bold">Rs. {{ product.price }}</p>
                        <p class="mb-1 small"><i class="fas fa-map-marker-alt text-success me-1"></i> {{ product.location }}</p>
                        <div class="mt-auto pt-2 d-grid">
                          <a href="{% url 'main:product-detail' product.id %}" class="btn btn-success btn-sm"><i class="fas fa-eye me-2"></i>View Details</a>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% empty %}
                  <div class="col-12 text-center py-5">
                    <div class="empty-state">
                      <i class="far fa-heart fa-5x text-muted mb-3"></i>
                      <h4>Your Wishlist is Empty</h4>
                      <p class="text-muted">You haven't added any bikes to your wishlist yet.</p>
                      <a href="{% url 'main:buy_bikes' %}" class="btn btn-success mt-3">
                        <i class="fas fa-motorcycle me-2"></i>Browse Bikes
                      </a>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-footer bg-light py-3 text-center">
          <img src="{% static 'proj/images/logo.png' %}" alt="Resale Logo" height="40">
          <p class="text-muted mb-0 small mt-2">Save bikes you're interested in to your wishlist for easy access</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    transition: transform 0.3s;
  }
  .bike-card-hover {
    transition: all 0.3s ease;
    border: 1px solid transparent;
  }
  
  .bike-card-hover:hover {
    transform: translateY(-5px);
    border-color: #198754;
    box-shadow: 0 10px 20px rgba(25, 135, 84, 0.15) !important;
  }
  
  .nav-link {
    transition: all 0.3s;
    border-radius: 8px;
  }
  .nav-link:hover, .nav-link.active {
    background-color: #198754;
    color: white;
  }
  
  /* Wishlist button styles */
  .wishlist-btn {
    opacity: 0.7;
    transition: all 0.2s ease;
    z-index: 10;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .wishlist-btn:hover {
    opacity: 1;
    transform: scale(1.1);
  }
  
  .empty-state {
    padding: 2rem;
    color: #6c757d;
  }
</style>

<script>
// Wishlist functionality
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.wishlist-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var productId = this.getAttribute('data-product-id');
      var card = this.closest('.col-md-6');
      var csrftoken = getCookie('csrftoken');
      
      // Add a small animation
      this.querySelector('i').classList.add('fa-beat');
      
      fetch("{% url 'main:toggle_wishlist' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Accept': 'application/json',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        credentials: 'same-origin',
        body: 'product_id=' + productId
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then((data) => {
        // Check if the response indicates success
        if (data.success) {
          // Remove the card with animation
          card.style.opacity = '0';
          card.style.transform = 'scale(0.8)';
          
          setTimeout(function() {
            card.remove();
            
            // If no more items, show empty state
            if (document.querySelectorAll('.bike-card-hover').length === 0) {
              var emptyState = `
                <div class="col-12 text-center py-5">
                  <div class="empty-state">
                    <i class="far fa-heart fa-5x text-muted mb-3"></i>
                    <h4>Your Wishlist is Empty</h4>
                    <p class="text-muted">You haven't added any bikes to your wishlist yet.</p>
                    <a href="{% url 'main:buy_bikes' %}" class="btn btn-success mt-3">
                      <i class="fas fa-motorcycle me-2"></i>Browse Bikes
                    </a>
                  </div>
                </div>
              `;
              document.querySelector('.row.g-4').innerHTML = emptyState;
            }
            
            // Update header count
            document.querySelector('h4.mb-4.border-bottom').innerHTML = 
              `<i class="fas fa-heart me-2"></i>Saved Bikes (${data.count})`;
            
            // Update wishlist count in navbar
            var wishlistCountSpan = document.querySelector('.nav-link .badge');
            if (wishlistCountSpan) {
              wishlistCountSpan.textContent = data.count;
              if (data.count > 0) {
                wishlistCountSpan.style.display = '';
              } else {
                wishlistCountSpan.style.display = 'none';
              }
            }
          }, 300);
        } else if (!data.authenticated) {
          // User is not authenticated, redirect to login
          window.location.href = '{% url "main:login" %}?next=' + encodeURIComponent(window.location.pathname);
        } else {
          // Other error occurred, just remove the animation
          this.querySelector('i').classList.remove('fa-beat');
        }
      })
      .catch((error) => {
        console.error('Wishlist error:', error);
        // Silently handle the error - the item will still be removed on page refresh
        // Just update the UI to show it's still in the wishlist
        this.querySelector('i').classList.remove('fa-beat');
      });
    });
  });
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
